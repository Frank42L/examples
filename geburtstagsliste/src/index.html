<!DOCTYPE html>
<html>
<head>
    <title>First-Steps (Frank42L)</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/style_core_elements.css">
    <link rel="stylesheet" href="assets/css/style_mk.css">
    <link rel="stylesheet" href="assets/css/style_mk_birthday.css">
    <link rel="stylesheet" href="assets/css/rwrd_simulation.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>

    <script src="js/jquery.js"></script>
    <script>
        function getAge(day, month, year) {
            const parsed_d = parseInt(day, 10);
            const parsed_m = parseInt(month, 10);
            const parsed_y = parseInt(year, 10);
            const today = new Date();
            var d2 = 0;
            var d1 = 0;
            if (isNaN(parsed_d) || parsed_d <= 0) {return -1;}
            if (isNaN(parsed_m) || parsed_d <= 0) {return -1;}
            if (isNaN(parsed_y)) {return -1;}
            d2 = parsed_y*10000 + parsed_m*100 + parsed_d;
            d1 = today.getFullYear()*10000 + (today.getMonth()+1)*100 + today.getDate();
            return Math.trunc((d1-d2)/10000);
        }

        function prepareMonths() {
            var item_months = [];

            $.getJSON( "data/frank.loeliger.config.json", function( data ) {
                $.each( data.Months, function( key, val ) {
                    item_months.push( "<stzh-mk-birthday-month id='month_" + val.cnt + "'><span slot='month'>" 
                        + val.month + "</span>" 
                        + "</stzh-mk-birthday-month>" );
                });

                $( "<stzh-mk-birthday-board/>", {
                    "title": "Geburtstage",
                    html: "<span slot='title'>Geburtstagsliste 42a</span>"+item_months.join( "" )
                }).appendTo( "body" );
            });
        }

        function createDayIfNotExists(month, day) {
            if( $("#month_"+ month + "_" + day).length )  
            { 
                // console.log ("month_"+ month + "_" + day+" exists");
            } else 
            {
                // console.log("month_"+ month + "_" + day+" does not exist");
                $( "<stzh-mk-birthday-day id='month_"+ month + "_" + day+"'> "
                    + "<span slot='day'>" + day + "</span>"
                    + "</stzh-mk-birthday-day>"
                ).appendTo( $("#month_" + month) );
                // TODO - Order along day
            }
        }

        function birthdayExists(val) {
            if( $("#person_hash_"+ val.hash).length )  
            { 
                console.log ("person_hash_"+ val.hash + " exists (" + val.firstname + " " + val.surname + ")");
                return true;
            }
            return false;
        }

        function addBirthdayIfNotExists(val) {
            var age = 0;
            
            if (!birthdayExists(val)) {
                age = getAge(val.day, val.month, val.year);
                if (age > 0) {
                    $( "<div/>", {
                            "class": "my-new-list",
                            html: 
                            "  <stzh-mk-birthday-with-age id='person_hash_"+ val.hash + "'> "
                                + "  <span slot='firstname'>" + val.firstname + "</span>"
                                + "  <span slot='surname'>" + val.surname + "</span>"
                                + "  <span slot='day'>" + val.day + "</span> "
                                + "  <span slot='month'>" + val.month + "</span>" 
                                + "  <span slot='year'>" + val.year + "</span> "
                                + "  <span slot='age'>" + age + "</span> "
                                + "  <span slot='hash'>" + val.hash + "</span> "
                            + "  </stzh-mk-birthday>"
                        }).appendTo( $("#month_" + val.month + "_" + val.day) );
                } else {
                    $( "<div/>", {
                            "class": "my-new-list",
                            html: 
                            "  <stzh-mk-birthday id='person_hash_"+ val.hash + "'> "
                                + "  <span slot='firstname'>" + val.firstname + "</span>"
                                + "  <span slot='surname'>" + val.surname + "</span>"
                                + "  <span slot='day'>" + val.day + "</span> "
                                + "  <span slot='month'>" + val.month + "</span>" 
                                + "  <span slot='hash'>" + val.hash + "</span> "
                            + "  </stzh-mk-birthday>"
                        }).appendTo( $("#month_" + val.month + "_" + val.day) );
                }
                
                
                if (age >= 0) {
                    str_age = age;
                }
                if (val.year != null) {
                    str_year = val.year;
                }

            }
        }

        function addBirthdays(user) {
                console.log ("Laden " + user);

               $.getJSON("http://localhost:8080/jerseydemo/birthdays/user/" + user, function( data ) {

                $.each( data.birthdays, function( key, val ) {
                    if (val.month == null || val.day == null) {
                        val.month = 0;
                        val.day = 0;
                    } 

                    createDayIfNotExists(val.month, val.day);
                    addBirthdayIfNotExists(val);
                });
            });
        }

        function addUploadButton(buttontext, url) {
            $( "<stzh-mk-call-to-action "
                + "destination='" + url + "'" 
                + " buttontext='" + buttontext + "'"
                + ">"
                + "</stzh-mk-call-to-action>"
            ).appendTo( "body" );
        }

    </script>

    <h1>Geburtstagsliste - Test</h1>

    <h2>Testen des Uploads</h2>

    <h3>Bitte korrekt formatierte Files hochladen</h3>

    <form action="http://localhost:8080/jerseydemo/birthdays/user/frank.loeliger.test" 
            method="post"
            enctype="multipart/form-data"
            content-type="charset=utf-8">
        <p>Ersetze die Geburtstagsliste vollständig (Create/Replace)</p>
        <label for="upload_file">Create or Replace</label>
        <input type="file" id="upload_file" name="file" accept="application/json">
        <input type="submit">
    </form>

    <form action="http://localhost:8080/jerseydemo/birthdays/user/frank.loeliger.test" 
    method="post"
    enctype="multipart/form-data">
        <p>Ergänze die Geburtstagsliste (Update)</p>
        <input type="hidden" name="_rest_method" value="patch">
        <label for="update_file">Update</label>
        <input type="file" id="update_file" name="file" accept="application/json">
        <input type="submit">
    </form>

    <script>
        var urlShow = "http://localhost:8080/jerseydemo/birthdays/user/";
        var urlUpload = "http://localhost:8080/jerseydemo/birthdays/user/";

        prepareMonths();
        addUploadButton("Show Irène", urlShow + "irene.troxler");
        addUploadButton("Show Frank", urlShow + "frank.loeliger");
        // addUploadButton("Upload Test", urlUpload + "frank.loeliger.test");
        addBirthdays("irene.troxler");      
        addBirthdays("frank.loeliger");      
        addBirthdays("regression.test");      
    </script>


    <script src="skzMkDashboard.js" type="module"></script>
    <script src="skzMkDashboardCard.js" type="module"></script>
    <script src="skzMkCallToAction.js" type="module"></script>
    <script src="skzMkBirthdayBoard.js" type="module"></script>
    <script src="skzMkBirthday.js" type="module"></script>
    <script src="skzMkBirthdayWithAge.js" type="module"></script>
    <script src="skzMkBirthdayMonth.js" type="module"></script>
    <script src="skzMkBirthdayDay.js" type="module"></script>
</body>
</html>
